version: '3.3'

services:
  api:
    image: stephenreed/jenkins-java8-maven-git-toskosed:latest
    deploy:
      mode: replicated
      replicas: 3
      restart_policy:
        condition: on-failure
    env_file:
      - ./api-container.generated.env
    networks:
      - toskose-network
    ports:
      - "9001/tcp"
      - "8080:8000/tcp"
    volumes:
      - api-container-volume:/toskose/apps

  toskose-manager:
    image: diunipisocc/toskose-manager:latest
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    env_file:
      - ./toskose-manager.generated.env     
    networks:
      - toskose-network
    ports:
      - "10000:10000/tcp"
    volumes:
      - toskose-manager-volume:/toskose/logs
      - ./toskose.toml:/toskose/config/toskose.toml

networks:
  toskose-network:
    driver: overlay
    attachable: true

volumes:
  api-container-volume:
  toskose-manager-volume:
