version: '3.3'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TOSKOSE_UNIT_IMAGE: diunipisocc/toskose-unit:latest
        TOSCA_NODES_CONTAINER_IMAGE: stephenreed/jenkins-java8-maven-git:latest
        TOSCA_NODES_SOFTWARE_APPS_NAMES: api
        TOSCA_NODES_SOFTWARE_STUFF_PATH: ./node-1/
      labels:
        maintainer: "matteo.bogo@gmail.com"
        description: "contains two thinking api webapps"
    image: stephenreed/jenkins-java8-maven-git-toskosed:latest
    container_name: api-container
    # dependes_on
    deploy:
      mode: replicated # (or global)
      replicas: 3
      restart_policy:
        condition: on-failure
    # env_file
    environment:
      SUPERVISORD_HTTP_PORT: 9001
      SUPERVISORD_HTTP_USER: admin
      SUPERVISORD_HTTP_PASSWORD: admin
      SUPERVISORD_LOG_LEVEL: info
      # env associated to the apps hosted on the same container
      API_1_INPUT_REPO: https://github.com/jacopogiallo/thoughts-api
      API_1_INPUT_BRANCH: master
      API_1_INPUT_DBURL: mongodb
      API_1_INPUT_DBPORT: 27017
      API_1_INPUT_DBNAME: thoughtsSharing
      API_1_INPUT_COLLECTIONNAME: thoughts
    # expose:
    # extra_hosts:
    healthcheck:
      disable: true
    # logging:
    networks:
      toskose-network:
        aliases:
          - api
    ports:
      - "9001:9001/tcp"
    restart: always
    volumes:
      - api-volume:/toskose/apps

  toskose-manager:
    image: diunipisocc/toskose-manager:latest
    container_name: toskose-manager
    environment:
      TOSKOSE_LOGS_PATH: /toskose/logs
      TOSKOSE_APP_CONFIG_PATH: /toskose/config/toskose.toml
      TOSKOSE_APP_MODE: production
      TOSKOSE_MANAGER_PORT: 10000
      SECRET_KEY: test
    healthcheck:
      disable: true
    networks:
      toskose-network:
        aliases:
          - toskose-manager
    ports:
      - "10000:10000/tcp"
    volumes:
      - toskose-manager-volume:/toskose/logs
      - ./toskose.toml:/toskose/config/toskose.toml

networks:
  toskose-network:
    driver: overlay

volumes:
  api-volume:
  toskose-manager-volume:
