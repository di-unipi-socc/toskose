version: '3.3'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TOSKOSE_UNIT_IMAGE: diunipisocc/toskose-unit:latest
        TOSCA_NODES_CONTAINER_IMAGE: stephenreed/jenkins-java8-maven-git:latest
        TOSCA_NODES_SOFTWARE_APPS_NAMES: api
        TOSCA_NODES_SOFTWARE_STUFF_PATH: ./node-1/
      labels:
        maintainer: "matteo.bogo@gmail.com"
        description: "contains a thinking api webapp"
    image: stephenreed/jenkins-java8-maven-git-toskosed:latest
    container_name: api-container
    # dependes_on
    deploy:
      # placement:
      #   constraints:
      #     - node.role == worker
      mode: replicated
      replicas: 3
      restart_policy:
        condition: on-failure
      # endpoint_mode: dnsrr
    env_file:
      - ./api-container.generated.env
    # expose:
    # extra_hosts:
    healthcheck:
      disable: true
    # logging:
    networks:
      - toskose-network
    ports:
      - "9001:9001/tcp"
    restart: always
    volumes:
      - api-volume:/toskose/apps

  toskose-manager:
    image: diunipisocc/toskose-manager:latest
    container_name: toskose-manager
    environment:
      TOSKOSE_LOGS_PATH: /toskose/logs
      TOSKOSE_APP_CONFIG_PATH: /toskose/config/toskose.toml
      TOSKOSE_APP_MODE: production
      TOSKOSE_MANAGER_PORT: 10000
      SECRET_KEY: test
    deploy:
      # placement:
      #   constraints:
      #     - node.role == manager
          # - node.id
          # - node.hostname
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      endpoint_mode: vip
    healthcheck:
      disable: true
    networks:
      - toskose-network
    ports:
      - "10000:10000/tcp"
    volumes:
      - toskose-manager-volume:/toskose/logs
      - ./toskose.toml:/toskose/config/toskose.toml

networks:
  toskose-network:
    driver: overlay

volumes:
  api-volume:
  toskose-manager-volume:
